services:
  flink-jobmanager:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.flink
    image: flink:1.19.3-scala_2.12-java17-docker
    container_name: flink-jobmanager
    command: jobmanager
    environment:
      JOB_MANAGER_RPC_ADDRESS: flink-jobmanager
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        jobmanager.bind-host: 0.0.0.0
        rest.bind-address: 0.0.0.0
        parallelism.default: 4
    ports:
      - "56478:8081"
      - "6123:6123"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/overview >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - ci

  flink-taskmanager:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.flink
    image: flink:1.19.3-scala_2.12-java17-docker
    container_name: flink-taskmanager
    command: taskmanager
    depends_on:
      flink-jobmanager:
        condition: service_healthy
    environment:
      JOB_MANAGER_RPC_ADDRESS: flink-jobmanager
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        parallelism.default: 4
      DOCKER_HOST: unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - ci
    user: "0:0"
    privileged: true

networks:
  ci:
    name: ci
